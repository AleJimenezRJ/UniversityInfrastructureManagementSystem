@page "/areas/mostrar-area/{AreaName}"

@using UCR.ECCI.PI.ThemePark.Frontend.Blazor.Application.Services
@using UCR.ECCI.PI.ThemePark.Frontend.Blazor.Domain.Entities.UniversityManagement
@using UCR.ECCI.PI.ThemePark.Frontend.Blazor.Presentation.Components
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization

@attribute [Authorize(Policy = "View Specific Area")]
@inject IAreaServices AreaServices
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IPermissionContext PermissionContext

<CleanBreadcrumbs EntityName="@AreaName"/>
<PageTitle>Area @area?.Name.Name</PageTitle>

<h3 class="text-h1 mt-4 ms-3" style="color: #2c5f7c;">Información de Área</h3>

@if (isLoading)
{
    <Spinner />
}
else if (area is not null)
{
    <MudContainer MaxWidth="MaxWidth.False">
        <MudPaper Class="px-6 py-4" Elevation="1" Style="max-width: 1000px; margin: auto; border-radius: 8px;">
            <MudGrid Spacing="2" Class="mb-4" Style="padding-left: 16px; padding-right: 16px;">

                <TitleLabel Label="Nombre" />
                <ValueLabel Value="@area.Name.Name" />

                <MudItem xs="12"><div style="height: 16px;"></div></MudItem>

                <TitleLabel Label="Sede" />
                <ValueLabel Value="@area.Campus.Name.Name" />

                <TitleLabel Label="Universidad" />
                <ValueLabel Value="@area.Campus.University.Name.Name" />

            </MudGrid>


            <div class="button-container">
                <CustomButton ButtonType="cancel"
                              Variant="Variant.Outlined"
                              OnClick="@(() => NavigationManager.NavigateTo("/areas"))">
                    ATRÁS
                </CustomButton>

                <AuthorizeView Policy="Delete Areas">
                    <Authorized>
                        <CustomButton ButtonType="delete"
                                      Variant="Variant.Filled"
                                      OnClick="@OnDeleteClicked">
                            BORRAR
                        </CustomButton>
                    </Authorized>
                </AuthorizeView>
                
            </div>

            <ConfirmDialog @ref="DeleteDialog"
                           Title="Confirmación"
                           Message="żEstás seguro de que deseas eliminar esta area?"
                           OkText="Eliminar"
                           CancelText="Cancelar"
                           ColorVarOk="--color-primary1" />
        </MudPaper>
    </MudContainer>

     
}
else
{
    <p><em>Area no encontrada.</em></p>
}

@if (showError)
{
    <div class="alert alert-danger" role="alert">
        @errorMessage
    </div>
}

@code {
    [Parameter]
    public string AreaName { get; set; } = string.Empty;

    private Area? area;
    private bool isLoading = true;
    private bool showError = false;
    private string errorMessage = string.Empty;
    private PopupMessage? _popupMessageRef;

    private ConfirmDialog? DeleteDialog;

    private async Task OnDeleteClicked()
    {
        showError = false;
        errorMessage = string.Empty;

        bool confirmed = await DeleteDialog!.ShowAsync();

        if (!confirmed)
            return;

        try
        {
            var deleted = await AreaServices.DeleteAreaAsync(AreaName);

            if (deleted)
            {
                Snackbar.Add("Area eliminada exitosamente.", Severity.Success);
                NavigationManager.NavigateTo("/areas");
            }
            else
            {
                showError = true;
                errorMessage = "No se pudo eliminar el área.";
            }
        }
        catch (Exception ex)
        {
            showError = true;
            errorMessage = $"Ocurrió un error inesperado: {ex.Message}";
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            area = await AreaServices.GetByNameAsync(AreaName);
        }
        catch
        {
            area = null;
        }
        finally
        {
            isLoading = false;
        }
    }

    private void HandleOk()
    {
        NavigationManager.NavigateTo("/areas");
    }
}
